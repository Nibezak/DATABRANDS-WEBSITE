---
import { getLocale, getUI } from '~/utils/i18n'
import Description from './Description.astro'
import { Image } from 'astro:assets'
import canvas1 from '~/assets/canvas-1.png'
import analytics1 from '~/assets/analytics-1.png'
import socialListening from '~/assets/social-listening-1.png'
import schedulePosts from '~/assets/schedule-posts.png'
import Video from './Video.astro'

const locale = getLocale(Astro)

const {
  routes: {
    index: { features },
  },
} = getUI(locale)

interface Props {
  titles?: string[]
}

const { titles } = Astro.props
const descriptions = Object.values(features.featureTabs).map(tab => tab.description)
---

<section
  id="features"
  class="relative mx-auto mb-8 mt-12 flex w-full flex-col text-start lg:mb-24 lg:mt-32"
>
  <div class="mb-2 w-full px-6 text-center lg:mb-4 lg:px-0">
    <h2 class="mb-4 text-4xl font-bold sm:text-6xl">Features & Capabilities</h2>
    <p class="mx-auto max-w-2xl text-lg opacity-80">
      Tools designed to give you clarity and control.
      <br class="hidden sm:block" />
      Everything you need to manage your brand's presence in one workspace.
    </p>
  </div>

  <div
    class="flex flex-col items-center justify-start overflow-hidden px-6 py-12 md:justify-center lg:sticky lg:top-0 lg:min-h-screen lg:px-8"
  >
    <div class="container mx-auto flex flex-col gap-6 lg:flex-row lg:justify-between lg:gap-12">
      <div class="flex w-full flex-col justify-center lg:w-1/4">
        <!-- Mobile Tabs -->
        <div class="flex gap-2 overflow-x-auto overflow-y-clip lg:hidden">
          {
            Object.entries(features.featureTabs).map(([key, tab], i) => (
              <button
                class="feature-tab whitespace-nowrap"
                data-index={i}
                data-feature-key={key}
                data-active={i === 0 ? 'true' : undefined}
              >
                {tab.title}
              </button>
            ))
          }
        </div>

        <!-- Desktop features list -->
        <div id="features-list" class="hidden lg:flex lg:flex-col lg:gap-4">
          {
            Object.entries(features.featureTabs).map(([key, tab], i) => (
              <div
                class="feature"
                data-index={i}
                data-feature-key={key}
                data-active={i === 0 ? 'true' : undefined}
              >
                <Description class="text-2xl font-bold">{tab.title}</Description>
                <Description>{tab.description}</Description>
              </div>
            ))
          }
        </div>

        <!-- Mobile description -->
        <div
          class="feature-description mt-4 lg:hidden"
          data-descriptions={descriptions.join('|||')}
        >
        </div>
      </div>

      <!-- Video Section -->
      <div class="flex h-fit w-full items-center justify-center lg:mt-20 lg:flex-1">
        <div class="relative w-full">
          <div class="video-stack relative h-full w-full">
            <div class="feature-video aspect-video w-full !opacity-100" data-name="workspaces">
              <Image
                src={analytics1}
                alt="Platform Analytics Preview"
                class="h-full w-full rounded-3xl bg-white object-contain !opacity-100 shadow-md grayscale transition-all duration-500 hover:grayscale-0"
              />
            </div>
            <div class="feature-video aspect-video w-full !opacity-100" data-name="compact-mode">
              <Image
                src={canvas1}
                alt="Creative Canvas Preview"
                class="h-full w-full rounded-3xl bg-white object-contain !opacity-100 shadow-md grayscale transition-all duration-500 hover:grayscale-0"
              />
            </div>
            <div class="feature-video aspect-video w-full !opacity-100" data-name="glance">
              <Image
                src={socialListening}
                alt="Social Listening Preview"
                class="h-full w-full rounded-3xl bg-white object-contain !opacity-100 shadow-md grayscale transition-all duration-500 hover:grayscale-0"
              />
            </div>
            <div class="feature-video aspect-video w-full !opacity-100" data-name="split-views">
              <Image
                src={schedulePosts}
                alt="Schedule Posts Preview"
                class="h-full w-full rounded-3xl bg-white object-contain !opacity-100 shadow-md grayscale transition-all duration-500 hover:grayscale-0"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { animate, stagger } from 'animejs'

  // Animate Titles
  animate('.title-line', {
    opacity: [0, 1],
    delay: stagger(200, { start: 200 }),
    duration: 600,
    easing: 'easeOutQuad',
  })

  animate('.feature-description-text', {
    opacity: [0, 1],
    delay: 600,
    duration: 600,
    easing: 'easeOutQuad',
  })

  animate('.feature-tab, .feature', {
    opacity: [0, 1],
    delay: stagger(200, { start: 800 }),
    duration: 500,
    easing: 'easeOutQuad',
  })

  const featuresSection = document.getElementById('features') as HTMLElement
  const features = document.querySelectorAll('.feature, .feature-tab') as NodeListOf<HTMLElement>
  const descriptionEl = document.querySelector('.feature-description') as HTMLDivElement | null
  const descriptions = descriptionEl?.dataset.descriptions?.split('|||')
  const videos = document.querySelectorAll('.feature-video') as NodeListOf<
    HTMLVideoElement | HTMLDivElement
  >

  /**
   * Switches the active feature and animates the videos.
   */
  function changeToFeature(index: number) {
    if (isNaN(index)) return

    // Toggle active states
    features.forEach((el, i) => {
      const elIndex = parseInt(el.dataset.index as string, 10)
      if (elIndex === index) {
        el.dataset.active = 'true'
      } else {
        delete el.dataset.active
      }
    })

    // Update mobile description
    if (descriptionEl && descriptions) {
      descriptionEl.textContent = descriptions[index]
    }

    // Animate videos
    videos.forEach((vid, i) => {
      const yOffset = (i - index) * 20
      const zOffset = i === index ? 0 : -100 - Math.abs(i - index) * 50
      const scale = i === index ? 1 : 0.95
      const rotation = (i - index) * 3

      if (i === index) {
        vid.setAttribute('data-active', 'true')
        vid.style.opacity = '1'
        vid.style.transform = `translate3d(-50%, 0, 0) scale(${scale})`
        vid.style.zIndex = '10'
        if (vid instanceof HTMLVideoElement && vid.paused) {
          vid.currentTime = 0
          vid.play()
        }
      } else {
        vid.removeAttribute('data-active')
        vid.style.transform = `translate3d(-50%, ${yOffset}px, ${zOffset}px) rotate3d(1, 0, 0, ${rotation}deg) scale(${scale})`
        vid.style.zIndex = String(1 - Math.abs(i - index))
        if (vid instanceof HTMLVideoElement) {
          vid.pause()
        }
      }
    })
  }

  // Set up click listeners for mobile tabs
  document.querySelectorAll('.feature-tab').forEach(f => {
    f.addEventListener('click', e => {
      const target = (e.target as HTMLElement).closest('.feature-tab') as HTMLElement
      if (target) {
        const index = parseInt(target.dataset.index || '0', 10)
        changeToFeature(index)
      }
    })
  })

  // Scroll handler for pinned section
  function handleScroll() {
    if (!featuresSection) return

    const rect = featuresSection.getBoundingClientRect()
    const sectionHeight = featuresSection.offsetHeight
    const windowHeight = window.innerHeight

    // Effective scrollable distance is the section height minus the viewport height
    const scrollableDistance = sectionHeight - windowHeight

    // How far have we scrolled past the start?
    const scrolled = -rect.top

    if (scrolled < 0) {
      changeToFeature(0)
      return
    }

    if (scrolled > scrollableDistance) {
      changeToFeature(3) // Last index
      return
    }

    const progress = scrolled / scrollableDistance
    const totalFeatures = 4

    // Map progress (0-1) to discrete indices (0-3)
    const index = Math.min(Math.floor(progress * totalFeatures), totalFeatures - 1)

    changeToFeature(index)
  }

  function scrollToFeature(index: number) {
    if (!featuresSection) return
    const sectionHeight = featuresSection.offsetHeight
    const windowHeight = window.innerHeight
    const scrollableDistance = sectionHeight - windowHeight
    const totalFeatures = 4

    // Target the middle of the feature's scroll range to be safe
    const progress = (index + 0.5) / totalFeatures
    const scrollWithinSection = progress * scrollableDistance

    const sectionTop = featuresSection.getBoundingClientRect().top + window.pageYOffset
    const targetY = sectionTop + scrollWithinSection

    window.scrollTo({
      top: targetY,
      behavior: 'smooth',
    })
  }

  // Set up click listeners for mobile tabs
  document.querySelectorAll('.feature-tab').forEach(f => {
    f.addEventListener('click', e => {
      const target = (e.target as HTMLElement).closest('.feature-tab') as HTMLElement
      if (target) {
        const index = parseInt(target.dataset.index || '0', 10)
        // Mobile doesn't use scroll-driven nav in the same way, but we can still switch it
        // For mobile, we prioritize the manual switch over scroll if needed,
        // but currently specific scroll linking is for desktop pinned layout.
        changeToFeature(index)
      }
    })
  })

  // Set up click listeners for desktop features
  document.querySelectorAll('.feature').forEach(f => {
    f.addEventListener('click', e => {
      const target = (e.target as HTMLElement).closest('.feature') as HTMLElement
      if (target) {
        const index = parseInt(target.dataset.index || '0', 10)
        scrollToFeature(index)
      }
    })
  })

  // Optimized scroll listener
  let ticking = false
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        handleScroll()
        ticking = false
      })
      ticking = true
    }
  })

  // Initial check
  handleScroll()
</script>
<style>
  #features {
    height: auto;
  }
  @media (min-width: 1024px) {
    #features {
      height: 300vh;
    }
  }

  .feature {
    @apply w-full cursor-pointer select-none rounded-lg p-4 opacity-0 transition-opacity duration-300;

    &[data-active='true'] {
      @apply bg-dark opacity-100; /* Added bg-dark for selected state */

      /* Make text lighter to contrast with dark background if needed, leveraging Description component styles if possible, or global styles */
      & :global(*) {
        @apply text-paper !important;
      }
    }

    &:not([data-active='true']) {
      @apply opacity-40;
    }
  }

  .feature-tab {
    @apply rounded-lg px-4 py-2 text-lg font-medium opacity-0 hover:bg-subtle;
    transition: background 0.2s ease-in-out;

    &[data-active='true'] {
      @apply bg-subtle;
    }
  }

  .feature-description {
    @apply px-4 text-sm;
  }

  .video-stack {
    @apply aspect-video;
    perspective: 2000px;
    transform-style: preserve-3d;
  }

  .feature-video {
    @apply left-1/2 hidden transform rounded-3xl shadow-md lg:absolute lg:mx-auto lg:block lg:w-full;
    max-width: 1200px;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    position: absolute;
    top: 0;
    transform-origin: top center;
    backface-visibility: hidden;
    will-change: transform, opacity;
    transform: translate3d(-50%, 0, -100px) scale(0.95);
  }

  /* Don't animate translation on small screens */
  @media (max-width: 1024px) {
    .feature-video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transform: none !important;
      display: none;
      object-fit: cover;

      &[data-active='true'] {
        display: block;
        opacity: 1;
      }
    }

    .video-stack {
      @apply overflow-hidden rounded-xl;
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
    }
  }
</style>
